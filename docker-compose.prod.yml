# ================================================
# Docker Compose: React 프론트엔드 프로덕션 환경
# ================================================
#
# 이 파일은 GitHub Actions에서 SCP로 Lightsail 서버에 전송되어
# 프로덕션 환경에서 프론트엔드 컨테이너를 실행하는 데 사용됩니다.
#
# 특징:
# 1. prod-network에 연결하여 백엔드(prod-backend)와 통신
# 2. Nginx가 /api와 /auth 요청을 백엔드로 프록시
# 3. React SPA 라우팅 지원 (모든 경로 → index.html)
# 4. 헬스체크를 통한 컨테이너 상태 모니터링
#
# 네트워크 구조:
# ┌─────────────────────────────────────────────────┐
# │              prod-network (공유 네트워크)        │
# │                                                 │
# │  ┌────────────┐  ┌────────────┐  ┌──────────┐ │
# │  │prod-backend│  │prod-frontend│  │  mysql   │ │
# │  │   :9080    │←─│    :80     │  │  :3306   │ │
# │  └────────────┘  └────────────┘  └──────────┘ │
# └─────────────────────────────────────────────────┘
#
# 사용 방법:
#   sudo docker compose -f docker-compose.prod.yml pull
#   sudo docker compose -f docker-compose.prod.yml up -d
#
# ================================================

services:
  # ========================================
  # 프론트엔드 서비스 (React + Nginx)
  # ========================================
  frontend:
    # GHCR에서 이미지 다운로드
    # - GitHub Actions에서 빌드하여 푸시한 이미지
    # - ${GITHUB_REPOSITORY}는 워크플로우에서 치환됨
    # - 수동 배포 시에는 아래 이미지 이름을 직접 지정
    # 예: ghcr.io/icesnake72/sbs:latest
    image: ghcr.io/sie07042/sbs:latest

    # 컨테이너 이름 (고정)
    # - 백엔드에서 이 이름으로 참조할 수 있음
    # - 로그 확인 시 사용: docker logs prod-frontend
    container_name: prod-frontend

    # 포트 매핑
    # - 호스트의 80번 포트를 컨테이너의 80번 포트로 연결
    # - http://서버IP 로 접속하면 이 컨테이너로 연결됨
    ports:
      - "80:80"

    # 네트워크 연결
    # - prod-network: 백엔드와 공유하는 Docker 네트워크
    # - 이 네트워크를 통해 prod-backend:9080으로 API 요청 가능
    networks:
      - prod-network

    # 헬스체크 설정
    # - 컨테이너가 정상적으로 응답하는지 주기적으로 확인
    # - 실패 시 Docker가 자동으로 컨테이너 재시작
    healthcheck:
      # wget으로 localhost에 HTTP 요청
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      # 30초마다 체크
      interval: 30s
      # 10초 내에 응답이 없으면 실패
      timeout: 10s
      # 3번 연속 실패 시 unhealthy 상태
      retries: 3
      # 컨테이너 시작 후 10초 대기 (초기화 시간)
      start_period: 10s

    # 로깅 설정
    # - json-file 드라이버 사용 (기본값)
    # - 로그 파일 크기 제한으로 디스크 공간 관리
    logging:
      driver: "json-file"
      options:
        # 로그 파일당 최대 10MB
        max-size: "10m"
        # 최대 3개 파일 유지 (총 30MB)
        max-file: "3"

    # 재시작 정책
    # - unless-stopped: 수동으로 중지하지 않는 한 항상 재시작
    # - 서버 재부팅 시에도 자동으로 컨테이너 시작
    restart: unless-stopped

# ========================================
# 네트워크 정의
# ========================================
networks:
  # 백엔드에서 이미 생성한 prod-network를 사용
  # - external: true로 설정하여 기존 네트워크에 연결
  # - 백엔드가 먼저 배포되어 있어야 함 (네트워크 생성)
  # - 또는 수동으로 생성: docker network create prod-network
  prod-network:
    external: true

# ================================================
# 트러블슈팅
# ================================================
#
# Q1. "network prod-network not found" 오류
# A1. 백엔드를 먼저 배포하거나 수동으로 네트워크 생성
#     docker network create prod-network
#
# Q2. 502 Bad Gateway (API 요청 실패)
# A2. 백엔드 컨테이너 상태 확인
#     docker ps | grep prod-backend
#     docker logs prod-backend
#
# Q3. 이미지 pull 실패
# A3. GHCR 로그인 확인
#     docker login ghcr.io
#
# Q4. 헬스체크 실패
# A4. 컨테이너 로그 확인
#     docker logs prod-frontend
#
# ================================================
