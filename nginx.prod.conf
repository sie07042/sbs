# ==========================================
# Nginx 설정: React SPA + API Proxy (프로덕션)
# ==========================================
#
# 이 설정 파일의 역할:
# 1. React SPA(Single Page Application) 정적 파일 서빙
# 2. /api/* 요청을 백엔드 서버로 프록시 (REST API)
# 3. /auth/* 요청을 백엔드 서버로 프록시 (OAuth 인증)
# 4. Gzip 압축으로 전송 크기 최적화
# 5. 정적 파일 캐싱으로 성능 최적화
# 6. 보안 헤더 설정
#
# 네트워크 환경:
# - prod-network Docker 네트워크 내에서 실행
# - 백엔드 컨테이너: prod-backend (포트 9080)
# - 프론트엔드 컨테이너: prod-frontend (포트 80)
#
# 요청 흐름:
# 브라우저 → Nginx(:80) → 정적 파일 또는 → 백엔드(:9080)
#
# ==========================================

server {
    # ==========================================
    # 기본 서버 설정
    # ==========================================

    # 80 포트에서 HTTP 요청 수신
    # HTTPS 사용 시 443 포트 추가 및 SSL 설정 필요
    listen 80;

    # 서버 이름 (요청을 처리할 도메인/IP)
    # - Lightsail 서버 IP: 실제 서비스 접속용
    # - localhost: 컨테이너 내부 헬스체크용
    # - 도메인 추가 시: server_name example.com www.example.com;
    server_name 16.184.53.118 localhost;

    # 웹 루트 디렉토리
    # Dockerfile.prod에서 COPY한 React 빌드 결과물 위치
    root /usr/share/nginx/html;

    # 기본 인덱스 파일
    index index.html;

    # ==========================================
    # Gzip 압축 설정 (성능 최적화)
    # ==========================================
    # Gzip 압축을 사용하면 전송 크기를 60-80% 줄일 수 있습니다.
    # 특히 텍스트 기반 파일(HTML, CSS, JS, JSON)에 효과적입니다.

    # Gzip 압축 활성화
    gzip on;

    # Vary: Accept-Encoding 헤더 추가
    # 프록시 서버가 압축/비압축 버전을 올바르게 캐시하도록 함
    gzip_vary on;

    # 최소 압축 크기 (1KB 미만은 압축하지 않음)
    # 작은 파일은 압축 오버헤드가 더 클 수 있음
    gzip_min_length 1024;

    # 프록시된 요청에 대한 압축 조건
    # expired, no-cache, no-store, private, auth 응답에 대해 압축
    gzip_proxied expired no-cache no-store private auth;

    # 압축할 MIME 타입 목록
    # 이미지(jpg, png, gif)는 이미 압축되어 있으므로 제외
    gzip_types text/plain text/css text/xml text/javascript application/x-javascript application/xml application/javascript application/json;

    # IE 6 이하에서는 Gzip 비활성화 (호환성 문제)
    gzip_disable "MSIE [1-6]\.";

    # ==========================================
    # API 프록시 설정 (/api 경로)
    # ==========================================
    # /api로 시작하는 모든 요청을 백엔드 서버로 프록시합니다.
    #
    # 예시:
    # - /api/users → http://prod-backend:9080/api/users
    # - /api/auth/login → http://prod-backend:9080/api/auth/login
    #
    # 프론트엔드에서 API 호출 시:
    #   axios.get('/api/users')  // Nginx가 백엔드로 전달
    #
    location /api/ {
        # 백엔드 서버 주소
        # ============================================
        # Docker 네트워크(prod-network) 내에서는 컨테이너 이름으로
        # 다른 컨테이너에 접근할 수 있습니다.
        # prod-backend: 백엔드 docker-compose.prod.yml에서 정의한 컨테이너 이름
        # 9080: Spring Boot 서버 포트
        proxy_pass http://prod-backend:9080;

        # 프록시 헤더 설정
        # ============================================
        # 백엔드가 원본 클라이언트 정보를 알 수 있도록 헤더 전달

        # Host: 원본 요청의 Host 헤더 (도메인/IP)
        proxy_set_header Host $host;

        # X-Real-IP: 실제 클라이언트 IP 주소
        proxy_set_header X-Real-IP $remote_addr;

        # X-Forwarded-For: 프록시 체인을 통과한 클라이언트 IP 목록
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

        # X-Forwarded-Proto: 원본 요청의 프로토콜 (http 또는 https)
        proxy_set_header X-Forwarded-Proto $scheme;

        # CORS 관련 헤더 전달
        # ============================================
        # Origin 헤더를 백엔드로 전달하여 CORS 처리 가능하게 함
        proxy_set_header Origin $http_origin;

        # 타임아웃 설정
        # ============================================
        # 긴 요청(파일 업로드, OAuth 등)을 위해 60초로 설정
        proxy_connect_timeout 60s;  # 백엔드 연결 타임아웃
        proxy_send_timeout 60s;      # 요청 전송 타임아웃
        proxy_read_timeout 60s;      # 응답 읽기 타임아웃

        # 쿠키 전달 설정
        # ============================================
        # 인증 쿠키(세션, JWT 등)가 올바르게 전달되도록 설정
        proxy_cookie_path / /;

        # 버퍼링 비활성화
        # ============================================
        # 실시간 응답이 필요한 경우(SSE, 스트리밍 등)를 위해 비활성화
        # 버퍼링을 비활성화하면 응답이 즉시 클라이언트에 전달됨
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # ==========================================
    # OAuth 인증 프록시 설정 (/auth 경로)
    # ==========================================
    # /auth로 시작하는 모든 요청을 백엔드 서버로 프록시합니다.
    # 주로 OAuth 인증(카카오, 구글, 네이버 등) 관련 요청을 처리합니다.
    #
    # OAuth 인증 흐름:
    # 1. 프론트엔드: /auth/kakao/login 요청
    # 2. Nginx: 백엔드로 프록시
    # 3. 백엔드: 카카오 인증 서버로 리다이렉트
    # 4. 사용자: 카카오 로그인 수행
    # 5. 카카오: 백엔드 콜백 URL로 리다이렉트
    # 6. 백엔드: 토큰 발급 후 프론트엔드로 리다이렉트
    #
    # 예시 엔드포인트:
    # - /auth/kakao/login: 카카오 로그인 시작
    # - /auth/kakao/callback: 카카오 콜백 처리
    # - /auth/kakao/exchange-token: 토큰 교환
    #
    location /auth/ {
        # 백엔드 서버 주소
        proxy_pass http://prod-backend:9080;

        # 프록시 헤더 설정 (위 /api와 동일)
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CORS 관련 헤더 전달
        proxy_set_header Origin $http_origin;

        # 타임아웃 설정
        # ============================================
        # OAuth 인증은 외부 서버(카카오, 구글 등)와 통신하므로
        # 충분한 타임아웃이 필요합니다.
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;

        # 쿠키 전달 설정
        # ============================================
        # OAuth 인증 과정에서 세션 쿠키가 필요합니다.
        # 백엔드가 세션에 임시 토큰을 저장하고,
        # 인증 완료 후 해당 토큰을 조회하기 때문입니다.
        proxy_cookie_path / /;

        # 버퍼링 비활성화
        proxy_buffering off;
        proxy_request_buffering off;
    }

    # ==========================================
    # React SPA 라우팅 지원 (핵심 설정)
    # ==========================================
    # React Router의 클라이언트 사이드 라우팅을 위한 설정입니다.
    #
    # SPA(Single Page Application)의 특성:
    # - 모든 라우팅이 클라이언트(브라우저)에서 처리됨
    # - /login, /dashboard 등은 실제 파일이 아님
    # - 따라서 모든 경로에서 index.html을 반환해야 함
    #
    # 동작 방식:
    # 1. 사용자가 /login 접속
    # 2. Nginx: /login 파일 찾기 → 없음
    # 3. Nginx: /login/ 디렉토리 찾기 → 없음
    # 4. Nginx: /index.html 반환 (fallback)
    # 5. React Router: URL 확인 후 Login 컴포넌트 렌더링
    #
    location / {
        # try_files: 파일 존재 여부를 순서대로 확인
        # $uri: 요청된 경로 그대로 (/login)
        # $uri/: 요청된 경로 + / (/login/)
        # /index.html: 위 두 가지가 없으면 fallback
        try_files $uri $uri/ /index.html;

        # index.html 캐싱 비활성화
        # ============================================
        # index.html은 캐시하지 않아야 합니다.
        # 이유: 배포 시 새로운 JS/CSS 파일을 참조하도록
        #       index.html이 변경되기 때문입니다.
        #
        # Vite의 빌드 방식:
        # - JS/CSS 파일명에 해시 포함 (예: main.abc123.js)
        # - 코드 변경 시 해시가 변경됨
        # - index.html이 새 해시를 가진 파일을 참조
        #
        # 따라서:
        # - index.html: 캐시 안 함 (항상 최신)
        # - JS/CSS: 1년 캐시 (파일명 해시로 구분)
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        add_header Expires "0";
    }

    # ==========================================
    # 정적 파일 캐싱 설정 (성능 최적화)
    # ==========================================
    # JavaScript, CSS, 이미지, 폰트 등의 정적 파일에 대한 캐싱 설정입니다.
    #
    # Vite의 빌드 출력물:
    # - main.abc123.js (해시 포함)
    # - style.def456.css (해시 포함)
    # - logo.ghi789.png (해시 포함)
    #
    # 해시 기반 캐싱의 장점:
    # - 파일 내용이 변경되면 해시도 변경됨
    # - 따라서 1년 캐싱해도 안전함
    # - 새 버전 배포 시 브라우저가 새 파일을 다운로드함
    #
    # 정규표현식: ~* (대소문자 구분 없음)
    # \.(확장자)$: 해당 확장자로 끝나는 파일
    #
    location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot)$ {
        # 1년(365일) 동안 브라우저 캐시
        # 실제로는 파일 변경 시 해시가 바뀌므로 문제없음
        expires 1y;

        # Cache-Control 헤더
        # - public: CDN 등 중간 캐시도 저장 가능
        # - immutable: 이 파일은 절대 변경되지 않음을 명시
        #              (해시 기반이므로 사실상 변경 불가)
        add_header Cache-Control "public, immutable";

        # 파일이 없으면 404 반환
        # 정적 파일은 SPA fallback(index.html) 하지 않음
        # 없는 이미지를 요청하면 그냥 404가 맞음
        try_files $uri =404;
    }

    # ==========================================
    # 에러 페이지 설정
    # ==========================================

    # 404 에러 처리
    # ============================================
    # SPA에서 404 에러도 index.html로 보내야 합니다.
    # React Router에서 경로를 확인하고 404 페이지를 렌더링합니다.
    #
    # 예: 사용자가 /없는페이지 접속
    # 1. Nginx: 파일 없음 → 404
    # 2. error_page 설정으로 index.html 반환
    # 3. React Router: 경로 매칭 실패 → NotFound 컴포넌트 렌더링
    error_page 404 /index.html;

    # 50x 서버 에러 페이지
    # ============================================
    # 500: Internal Server Error (서버 내부 오류)
    # 502: Bad Gateway (프록시 대상 서버 연결 실패)
    # 503: Service Unavailable (서비스 이용 불가)
    # 504: Gateway Timeout (프록시 대상 서버 응답 시간 초과)
    #
    # 이 에러들은 별도의 50x.html 파일로 처리합니다.
    # 50x.html 파일은 React 앱과 별개로 존재해야 합니다.
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }

    # ==========================================
    # 보안 헤더 설정
    # ==========================================
    # 웹 보안을 강화하는 HTTP 헤더들입니다.
    # 모든 응답에 항상(always) 포함됩니다.

    # X-Content-Type-Options: nosniff
    # ============================================
    # MIME 타입 스니핑 방지
    # 브라우저가 Content-Type 헤더를 무시하고 내용을 추측하는 것을 방지
    # 예: text/plain인 JS 파일을 실행하는 것을 방지
    add_header X-Content-Type-Options "nosniff" always;

    # X-Frame-Options: DENY
    # ============================================
    # 클릭재킹(Clickjacking) 공격 방지
    # 이 페이지가 iframe 내에 표시되는 것을 금지
    # DENY: 모든 경우 금지
    # SAMEORIGIN: 같은 도메인만 허용
    add_header X-Frame-Options "DENY" always;

    # X-XSS-Protection: 1; mode=block
    # ============================================
    # 브라우저 내장 XSS 필터 활성화
    # XSS 공격이 감지되면 페이지 렌더링을 중단
    # 최신 브라우저에서는 deprecated되었지만, 구형 브라우저 대응용
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer-Policy: no-referrer-when-downgrade
    # ============================================
    # Referer 헤더 전송 정책
    # HTTPS → HTTP로 이동 시에만 Referer 제거
    # 같은 보안 수준이면 Referer 전송 (분석 도구용)
    add_header Referrer-Policy "no-referrer-when-downgrade" always;

    # ==========================================
    # 로그 설정
    # ==========================================
    # Nginx 로그 파일 위치
    # Docker 컨테이너 내부 경로입니다.
    #
    # 로그 확인 방법:
    #   docker exec prod-frontend cat /var/log/nginx/access.log
    #   docker exec prod-frontend tail -f /var/log/nginx/error.log
    #
    # 또는 docker logs 명령 사용:
    #   docker logs prod-frontend
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;
}

# ==========================================
# 추가 설정 가이드
# ==========================================
#
# HTTPS 설정 (Let's Encrypt 사용 시):
# ------------------------------------------
# server {
#     listen 443 ssl http2;
#     server_name example.com;
#
#     ssl_certificate /etc/letsencrypt/live/example.com/fullchain.pem;
#     ssl_certificate_key /etc/letsencrypt/live/example.com/privkey.pem;
#
#     # ... 나머지 설정 동일 ...
# }
#
# # HTTP → HTTPS 리다이렉트
# server {
#     listen 80;
#     server_name example.com;
#     return 301 https://$server_name$request_uri;
# }
#
# 도메인 추가 시:
# ------------------------------------------
# server_name example.com www.example.com;
#
# ==========================================
