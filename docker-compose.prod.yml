# ================================================
# 프로덕션 환경 Docker Compose
# AWS Lightsail 배포용 (React 프론트엔드)
# ================================================
#
# 구성 요소:
# 1. Nginx (React 정적 파일 서빙 + API 프록시)
#
# 특징:
# - 백엔드(prod-backend)와 같은 prod-network에서 실행
# - Nginx가 /api와 /auth 요청을 백엔드로 프록시
# - React SPA 라우팅 지원
# - 프로덕션 최적화 (gzip, 캐싱 등)
#
# ================================================

services:
  # ========================================
  # 프론트엔드 서비스 (React + Nginx)
  # ========================================
  frontend:
    # ========================================
    # Docker 이미지 설정
    # ========================================
    # GitHub Container Registry(GHCR)에서 미리 빌드된 이미지를 가져옴
    # - ghcr.io: GitHub Container Registry 주소
    # - icesnake72/sbs-frontend: 저장소명 (GitHub 사용자명/이미지명)
    # - latest: 태그 (가장 최신 버전)
    # - 이 이미지는 GitHub Actions에서 자동으로 빌드되어 업로드됨
    image: ghcr.io/icesnake72/sbs-frontend:latest

    # ========================================
    # 컨테이너 이름
    # ========================================
    # Docker에서 이 컨테이너를 식별하는 이름
    # - docker ps, docker logs prod-frontend 등의 명령에서 사용
    container_name: prod-frontend

    # ========================================
    # 포트 매핑
    # ========================================
    # 호스트(외부)와 컨테이너(내부) 포트 연결
    # - "80:80" 형식: "호스트포트:컨테이너포트"
    # - 외부에서 http://16.184.53.118 으로 접속 가능
    # - Nginx는 컨테이너 내부에서 80 포트로 실행됨
    ports:
      - "80:80"

    # ========================================
    # 네트워크 설정
    # ========================================
    # 백엔드와 같은 prod-network에 연결
    # - 같은 네트워크에 있어야 컨테이너 이름으로 백엔드 접근 가능
    # - Nginx가 prod-backend:9080으로 API 요청 프록시
    networks:
      - prod-network

    # ========================================
    # 의존성 설정 (선택적)
    # ========================================
    # 백엔드가 실행 중이어야 API 프록시 가능
    # - 하지만 프론트엔드는 백엔드 없이도 정적 파일 서빙 가능
    # - 따라서 depends_on은 설정하지 않음 (독립적 배포 가능)

    # ========================================
    # 헬스 체크 설정
    # ========================================
    # Docker가 컨테이너 상태를 주기적으로 확인
    healthcheck:
      # 헬스체크 명령어: Nginx가 응답하는지 확인
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      # 헬스체크 실행 주기: 30초마다
      interval: 30s
      # 타임아웃: 10초 안에 응답 없으면 실패
      timeout: 10s
      # 재시도 횟수: 3번 연속 실패하면 unhealthy
      retries: 3
      # 초기 대기 시간: 컨테이너 시작 후 10초 동안은 실패 무시
      start_period: 10s

    # ========================================
    # 로그 설정
    # ========================================
    # 디스크 공간 관리를 위한 로그 제한
    logging:
      # JSON 형식으로 로그 저장
      driver: "json-file"
      options:
        # 파일당 최대 10MB
        max-size: "10m"
        # 최대 3개 파일 보관 (총 30MB)
        max-file: "3"

    # ========================================
    # 재시작 정책
    # ========================================
    # 컨테이너 자동 재시작 설정
    # - unless-stopped: 수동 중지 전까지 항상 재시작
    # - 서버 재부팅 시 자동으로 다시 시작됨
    restart: unless-stopped

# ========================================
# 네트워크 정의
# ========================================
networks:
  # 백엔드에서 이미 생성한 prod-network를 사용
  # external: true로 설정하여 기존 네트워크에 연결
  prod-network:
    external: true

# ================================================
# 사용 방법
# ================================================
#
# ⚠️ 사전 조건
# ================================================
# 1. prod-network가 이미 생성되어 있어야 함
#    (백엔드 docker-compose.prod.yml 실행 시 자동 생성됨)
#
# 2. 백엔드(prod-backend)가 실행 중이어야 API 프록시 가능
#    docker compose -f docker-compose.prod.yml up -d
#
# ================================================
# 서비스 실행
# ================================================
#
# 1. GitHub Actions 자동 배포 (권장)
#    - git push origin main
#    - GitHub Actions가 자동으로 배포
#
# 2. 수동 배포 (Lightsail 서버에서)
#    docker compose -f docker-compose.prod.yml pull
#    docker compose -f docker-compose.prod.yml up -d
#
# 3. 로그 확인
#    docker compose -f docker-compose.prod.yml logs -f frontend
#
# 4. 서비스 재시작
#    docker compose -f docker-compose.prod.yml restart frontend
#
# 5. 전체 중지
#    docker compose -f docker-compose.prod.yml down
#
# ================================================
# 네트워크 구조
# ================================================
#
#  ┌─────────────────────────────────────────────────────────┐
#  │              prod-network (공유 네트워크)                │
#  │                                                         │
#  │   ┌──────────┐   ┌──────────────┐   ┌──────────────┐  │
#  │   │prod-mysql│   │ prod-backend │   │prod-frontend │  │
#  │   │  :3306   │<->│    :9080     │<->│    :80       │  │
#  │   │          │   │              │   │   (Nginx)    │  │
#  │   └──────────┘   └──────────────┘   └──────────────┘  │
#  │        ↑                ↑                  ↑          │
#  └────────┼────────────────┼──────────────────┼──────────┘
#           │                │                  │
#      포트 매핑         포트 매핑          포트 매핑
#   (server:3306)     (server:8080)      (server:80)
#           │                │                  │
#  ┌────────▼────────────────▼──────────────────▼──────────┐
#  │              AWS Lightsail 서버                        │
#  │              16.184.53.118                            │
#  │                                                       │
#  │   브라우저 → http://16.184.53.118 (프론트엔드)        │
#  │           → /api/* → Nginx → prod-backend:9080       │
#  │           → /auth/* → Nginx → prod-backend:9080      │
#  └───────────────────────────────────────────────────────┘
#
# 통신 흐름:
# 1. 브라우저가 http://16.184.53.118로 React 앱 요청
# 2. Nginx가 정적 파일(HTML, JS, CSS) 제공
# 3. React 앱이 /api/* 또는 /auth/* API 요청
# 4. Nginx가 요청을 prod-backend:9080으로 프록시
# 5. 백엔드가 prod-mysql:3306으로 DB 조회
# 6. 응답이 역순으로 전달
#
# ================================================
# 트러블슈팅
# ================================================
#
# Q1. "network prod-network not found" 오류
# A1. 백엔드를 먼저 실행하세요 (네트워크 자동 생성됨)
#     cd backend && docker compose -f docker-compose.prod.yml up -d
#
# Q2. 백엔드 연결 실패 (502 Bad Gateway)
# A2. 백엔드가 실행 중인지 확인
#     docker ps | grep prod-backend
#
# Q3. 이미지를 찾을 수 없음
# A3. GitHub Container Registry 로그인 필요
#     echo $GHCR_TOKEN | docker login ghcr.io -u USERNAME --password-stdin
#
# Q4. 포트 80이 이미 사용 중
# A4. 기존 웹 서버 중지
#     sudo lsof -i :80
#     sudo kill -9 <PID>
#
# ================================================
