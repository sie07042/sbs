# ================================================
# Docker Compose: React 프론트엔드 개발 환경
# 백엔드(myauth-backend-dev)와 같은 myauth-network에서 실행
# ================================================
#
# 특징:
# 1. 백엔드와 동일한 myauth-network에 연결하여 컨테이너 간 통신
# 2. Nginx가 /api와 /auth 요청을 백엔드로 프록시
# 3. React SPA 라우팅 지원 (모든 경로 → index.html)
#
# ================================================

services:
  # ========================================
  # 프론트엔드 서비스 (React + Nginx)
  # ========================================
  frontend:
    # 컨테이너 이름
    container_name: sbs-frontend

    # Dockerfile을 사용한 이미지 빌드
    build:
      context: .
      dockerfile: Dockerfile

    # 포트 매핑: 호스트의 80번 포트를 컨테이너의 80번 포트로 연결
    # http://localhost 또는 http://localhost:80 으로 접속 가능
    ports:
      - "80:80"

    # myauth-network에 연결 (백엔드와 동일한 네트워크)
    networks:
      - myauth-network

    # 재시작 정책: 수동 중지하지 않는 한 항상 재시작
    restart: unless-stopped

    # 헬스 체크: 프론트엔드가 정상 작동하는지 확인
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

# ========================================
# 네트워크 정의
# ========================================
networks:
  # 백엔드에서 이미 생성한 myauth-network를 사용
  # external: true로 설정하여 기존 네트워크에 연결
  myauth-network:
    external: true

# ================================================
# 사용 방법
# ================================================
#
# ⚠️ 사전 조건
# ================================================
# 1. myauth-network가 이미 생성되어 있어야 함
#    docker network create myauth-network
#
# 2. 백엔드(myauth-backend-dev)가 실행 중이어야 함
#    (백엔드 docker-compose.dev.yml 먼저 실행)
#
# ================================================
# 서비스 실행
# ================================================
#
# 1. 전체 서비스 시작 (빌드 포함)
#    docker-compose up -d --build
#
# 2. 서비스 시작 (빌드 제외)
#    docker-compose up -d
#
# 3. 로그 확인
#    docker-compose logs -f frontend
#
# 4. 서비스 상태 확인
#    docker-compose ps
#
# 5. 서비스 중지
#    docker-compose stop
#
# 6. 서비스 재시작
#    docker-compose restart
#
# 7. 서비스 중지 및 컨테이너 삭제
#    docker-compose down
#
# 8. 프론트엔드만 재빌드 및 재시작
#    docker-compose up -d --build frontend
#
# 9. 네트워크 연결 확인
#    docker network inspect myauth-network
#    # mysql-8, myauth-backend-dev, sbs-frontend가 모두 표시되어야 함
#
# ================================================
# 네트워크 구조
# ================================================
#
#  ┌─────────────────────────────────────────────────────────┐
#  │              myauth-network (공유 네트워크)              │
#  │                                                         │
#  │   ┌──────────┐   ┌──────────────┐   ┌──────────────┐  │
#  │   │ mysql-8  │   │   Backend    │   │  Frontend    │  │
#  │   │  :3306   │<->│    :9080     │<->│    :80       │  │
#  │   │ (기존)   │   │(myauth-backend│   │(sbs-frontend)│  │
#  │   │          │   │    -dev)     │   │              │  │
#  │   └──────────┘   └──────────────┘   └──────────────┘  │
#  │        ↑                ↑                  ↑          │
#  └────────┼────────────────┼──────────────────┼──────────┘
#           │                │                  │
#      포트 매핑         포트 매핑          포트 매핑
#   (localhost:3306)  (localhost:9080)   (localhost:80)
#           │                │                  │
#  ┌────────▼────────────────▼──────────────────▼──────────┐
#  │                    호스트 머신                         │
#  │                                                       │
#  │   브라우저 → http://localhost (프론트엔드)            │
#  │           → /api/* → Nginx → Backend → MySQL         │
#  │           → /auth/* → Nginx → Backend                │
#  └───────────────────────────────────────────────────────┘
#
# 통신 흐름:
# 1. 브라우저가 http://localhost로 React 앱 요청
# 2. Nginx가 정적 파일(HTML, JS, CSS) 제공
# 3. React 앱이 /api/* 또는 /auth/* API 요청
# 4. Nginx가 요청을 myauth-backend-dev:9080으로 프록시
# 5. 백엔드가 mysql-8:3306으로 DB 조회
# 6. 응답이 역순으로 전달
#
# ================================================
# 트러블슈팅
# ================================================
#
# Q1. "network myauth-network not found" 오류
# A1. 네트워크를 먼저 생성하세요
#     docker network create myauth-network
#
# Q2. 백엔드 연결 실패 (502 Bad Gateway)
# A2. 백엔드가 실행 중인지 확인
#     docker ps | grep myauth-backend-dev
#     백엔드가 없으면 먼저 실행:
#     cd ../backend && docker-compose -f docker-compose.dev.yml up -d
#
# Q3. 포트 80이 이미 사용 중
# A3. 다른 웹 서버 중지 또는 포트 변경
#     ports:
#       - "3000:80"  # localhost:3000으로 접속
#
# Q4. 빌드된 파일이 반영되지 않음
# A4. 캐시 없이 재빌드
#     docker-compose build --no-cache
#     docker-compose up -d
#
# ================================================
