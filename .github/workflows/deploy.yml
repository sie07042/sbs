# ================================================
# GitHub Actions: í”„ë¡ íŠ¸ì—”ë“œ ìžë™ ë°°í¬ ì›Œí¬í”Œë¡œìš°
# ================================================
#
# íŠ¸ë¦¬ê±°: main ë¸Œëžœì¹˜ì— pushë  ë•Œ ì‹¤í–‰
#
# ì›Œí¬í”Œë¡œìš° ë‹¨ê³„:
# 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
# 2. Docker ì´ë¯¸ì§€ ë¹Œë“œ
# 3. GitHub Container Registry(GHCR)ì— ì´ë¯¸ì§€ í‘¸ì‹œ
# 4. Lightsail ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ë°°í¬
#
# ================================================

name: Deploy Frontend to Lightsail

# ========================================
# íŠ¸ë¦¬ê±° ì„¤ì •
# ========================================
on:
  # main ë¸Œëžœì¹˜ì— pushë  ë•Œ ì‹¤í–‰
  push:
    branches:
      - main

  # ìˆ˜ë™ ì‹¤í–‰ í—ˆìš© (GitHub Actions íƒ­ì—ì„œ "Run workflow" ë²„íŠ¼)
  workflow_dispatch:

# ========================================
# í™˜ê²½ ë³€ìˆ˜
# ========================================
env:
  # GitHub Container Registry ê´€ë ¨
  REGISTRY: ghcr.io
  # ì´ë¯¸ì§€ ì´ë¦„: ghcr.io/ì‚¬ìš©ìžëª…/ì´ë¯¸ì§€ëª…
  # github.repositoryëŠ” "ì‚¬ìš©ìžëª…/ì €ìž¥ì†Œëª…" í˜•ì‹
  IMAGE_NAME: ${{ github.repository }}

# ========================================
# ìž‘ì—… ì •ì˜
# ========================================
jobs:
  # ========================================
  # ë¹Œë“œ ë° í‘¸ì‹œ ìž‘ì—…
  # ========================================
  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest

    # GHCRì— í‘¸ì‹œí•˜ê¸° ìœ„í•œ ê¶Œí•œ ì„¤ì •
    permissions:
      contents: read
      packages: write

    steps:
      # ========================================
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      # ========================================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ========================================
      # 2. Docker Buildx ì„¤ì •
      # ========================================
      # ë©€í‹° í”Œëž«í¼ ë¹Œë“œ ë° ìºì‹œ ì§€ì›ì„ ìœ„í•´ Buildx ì‚¬ìš©
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ========================================
      # 3. GitHub Container Registry ë¡œê·¸ì¸
      # ========================================
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          # GitHub Actionsì—ì„œ ìžë™ìœ¼ë¡œ ì œê³µí•˜ëŠ” í† í° ì‚¬ìš©
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # ========================================
      # 4. Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      # ========================================
      # ì´ë¯¸ì§€ íƒœê·¸ì™€ ë¼ë²¨ ìžë™ ìƒì„±
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            # latest íƒœê·¸
            type=raw,value=latest
            # ì»¤ë°‹ SHA íƒœê·¸ (ë¡¤ë°±ìš©)
            type=sha,prefix=

      # ========================================
      # 5. Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
      # ========================================
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          # í”„ë¡œë•ì…˜ìš© Dockerfile ì‚¬ìš©
          file: ./Dockerfile.prod
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # ë¹Œë“œ ìºì‹œ ì‚¬ìš© (ë¹Œë“œ ì†ë„ í–¥ìƒ)
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ========================================
  # ë°°í¬ ìž‘ì—…
  # ========================================
  deploy:
    name: Deploy to Lightsail
    runs-on: ubuntu-latest
    # ë¹Œë“œ ìž‘ì—…ì´ ì™„ë£Œëœ í›„ì— ì‹¤í–‰
    needs: build-and-push

    steps:
      # ========================================
      # 1. Lightsail ì„œë²„ì— SSH ì ‘ì†í•˜ì—¬ ë°°í¬
      # ========================================
      - name: Deploy to Lightsail via SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          # Lightsail ì„œë²„ IP (GitHub Secretsì— ì €ìž¥)
          host: ${{ secrets.LIGHTSAIL_HOST }}
          # SSH ì‚¬ìš©ìžëª…
          username: ${{ secrets.LIGHTSAIL_USERNAME }}
          # SSH ê°œì¸ í‚¤ (GitHub Secretsì— ì €ìž¥)
          key: ${{ secrets.LIGHTSAIL_SSH_KEY }}
          # ì‹¤í–‰í•  ëª…ë ¹ì–´
          script: |
            echo "=========================================="
            echo "ðŸš€ í”„ë¡ íŠ¸ì—”ë“œ ë°°í¬ ì‹œìž‘"
            echo "=========================================="

            # GitHub Container Registry ë¡œê·¸ì¸
            # GHCR_TOKENì´ ì„¤ì •ë˜ì–´ ìžˆìœ¼ë©´ ì‚¬ìš©, ì—†ìœ¼ë©´ íŒ¨í‚¤ì§€ê°€ publicì´ì–´ì•¼ í•¨
            echo "ðŸ“¦ GHCR ë¡œê·¸ì¸ ì‹œë„..."
            if [ -n "${{ secrets.GHCR_TOKEN }}" ]; then
              echo ${{ secrets.GHCR_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin
            else
              echo "âš ï¸ GHCR_TOKENì´ ì—†ìŠµë‹ˆë‹¤. íŒ¨í‚¤ì§€ê°€ publicìœ¼ë¡œ ì„¤ì •ë˜ì–´ ìžˆì–´ì•¼ í•©ë‹ˆë‹¤."
            fi

            # í”„ë¡ íŠ¸ì—”ë“œ ë””ë ‰í† ë¦¬ë¡œ ì´ë™ (ì—†ìœ¼ë©´ ìƒì„±)
            FRONTEND_DIR="/home/${{ secrets.LIGHTSAIL_USERNAME }}/frontend"
            mkdir -p $FRONTEND_DIR
            cd $FRONTEND_DIR

            # docker-compose.prod.yml íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸
            echo "ðŸ“ docker-compose.prod.yml ìƒì„± ì¤‘..."
            cat > docker-compose.prod.yml << 'EOF'
            services:
              frontend:
                image: ghcr.io/${{ github.repository }}:latest
                container_name: prod-frontend
                ports:
                  - "80:80"
                networks:
                  - prod-network
                healthcheck:
                  test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost/"]
                  interval: 30s
                  timeout: 10s
                  retries: 3
                  start_period: 10s
                logging:
                  driver: "json-file"
                  options:
                    max-size: "10m"
                    max-file: "3"
                restart: unless-stopped

            networks:
              prod-network:
                external: true
            EOF

            # ìµœì‹  ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
            echo "ðŸ“¥ ìµœì‹  ì´ë¯¸ì§€ í’€ë§ ì¤‘..."
            docker compose -f docker-compose.prod.yml pull

            # ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì¤‘ì§€ ë° ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œìž‘
            echo "ðŸ”„ ì»¨í…Œì´ë„ˆ ìž¬ì‹œìž‘ ì¤‘..."
            docker compose -f docker-compose.prod.yml up -d --force-recreate

            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬
            echo "ðŸ§¹ ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€ ì •ë¦¬ ì¤‘..."
            docker image prune -f

            # ë°°í¬ ê²°ê³¼ í™•ì¸
            echo "=========================================="
            echo "âœ… ë°°í¬ ì™„ë£Œ!"
            echo "=========================================="
            docker ps | grep prod-frontend

            # í—¬ìŠ¤ì²´í¬ ëŒ€ê¸°
            echo "â³ í—¬ìŠ¤ì²´í¬ ëŒ€ê¸° ì¤‘ (10ì´ˆ)..."
            sleep 10

            # í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ í™•ì¸
            echo "ðŸ” í”„ë¡ íŠ¸ì—”ë“œ ìƒíƒœ í™•ì¸..."
            curl -s -o /dev/null -w "%{http_code}" http://localhost/ || echo "Warning: Health check failed"

            echo "=========================================="
            echo "ðŸŽ‰ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ðŸŒ URL: http://${{ secrets.LIGHTSAIL_HOST }}"
            echo "=========================================="

# ================================================
# GitHub Secrets ì„¤ì • ê°€ì´ë“œ
# ================================================
#
# GitHub ì €ìž¥ì†Œ â†’ Settings â†’ Secrets and variables â†’ Actions
# ì—ì„œ ë‹¤ìŒ ì‹œí¬ë¦¿ë“¤ì„ ì¶”ê°€í•´ì•¼ í•©ë‹ˆë‹¤:
#
# 1. LIGHTSAIL_HOST
#    - Lightsail ì„œë²„ IP ì£¼ì†Œ
#    - ì˜ˆ: 16.184.53.118
#
# 2. LIGHTSAIL_USERNAME
#    - SSH ì ‘ì† ì‚¬ìš©ìžëª…
#    - ì˜ˆ: ubuntu (ê¸°ë³¸ê°’)
#
# 3. LIGHTSAIL_SSH_KEY
#    - Lightsail SSH ê°œì¸ í‚¤ ì „ì²´ ë‚´ìš©
#    - -----BEGIN RSA PRIVATE KEY----- ë¶€í„°
#    - -----END RSA PRIVATE KEY----- ê¹Œì§€ ì „ë¶€ ë³µì‚¬
#
# 4. GHCR_TOKEN (ì„ íƒì‚¬í•­)
#    - íŒ¨í‚¤ì§€ê°€ privateì¸ ê²½ìš°ì—ë§Œ í•„ìš”
#    - íŒ¨í‚¤ì§€ë¥¼ publicìœ¼ë¡œ ì„¤ì •í•˜ë©´ ë¶ˆí•„ìš”
#    - GitHub Personal Access Token (Classic)
#    - ê¶Œí•œ: read:packages, write:packages
#    - ìƒì„±: GitHub â†’ Settings â†’ Developer settings â†’ Personal access tokens
#
# ================================================
# íŒ¨í‚¤ì§€ Public ì„¤ì • ë°©ë²• (GHCR_TOKEN ëŒ€ì‹  ì‚¬ìš©)
# ================================================
#
# 1. GitHub ì €ìž¥ì†Œ íŽ˜ì´ì§€ â†’ ì˜¤ë¥¸ìª½ "Packages" ì„¹ì…˜ í´ë¦­
# 2. í•´ë‹¹ íŒ¨í‚¤ì§€ í´ë¦­ â†’ "Package settings"
# 3. "Danger Zone" â†’ "Change package visibility" â†’ "Public"
#
# ì´ë ‡ê²Œ í•˜ë©´ GHCR_TOKEN ì—†ì´ë„ ì´ë¯¸ì§€ pull ê°€ëŠ¥
#
# ================================================
# íŠ¸ëŸ¬ë¸”ìŠˆíŒ…
# ================================================
#
# Q1. "Permission denied" SSH ì˜¤ë¥˜
# A1. LIGHTSAIL_SSH_KEYê°€ ì˜¬ë°”ë¥¸ì§€ í™•ì¸
#     - ê°œì¸ í‚¤ ì „ì²´ë¥¼ ë³µì‚¬í–ˆëŠ”ì§€ í™•ì¸
#     - ì¤„ë°”ê¿ˆì´ ì œëŒ€ë¡œ í¬í•¨ë˜ì—ˆëŠ”ì§€ í™•ì¸
#
# Q2. "network prod-network not found" ì˜¤ë¥˜
# A2. ë°±ì—”ë“œë¥¼ ë¨¼ì € ë°°í¬í•˜ì„¸ìš” (ë„¤íŠ¸ì›Œí¬ ìžë™ ìƒì„±ë¨)
#
# Q3. ì´ë¯¸ì§€ í’€ ì‹¤íŒ¨
# A3. GHCR_TOKEN ê¶Œí•œ í™•ì¸
#     - read:packages ê¶Œí•œ í•„ìš”
#
# Q4. 502 Bad Gateway
# A4. ë°±ì—”ë“œê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸
#     docker ps | grep prod-backend
#
# ================================================
